import{j as e}from"./jsx-runtime-C-_spy54.js";import{u as P,a as K,b as p,c as h,d as f,F as g,e as j,t as $}from"./form-CvgtEUdj.js";import{y as B}from"./index-Cr0IeYe7.js";import{r as c}from"./index-aGVi9Z7h.js";import{t as X}from"./index-GyqvGh2n.js";import{z as n}from"./index-Cb7h-Ku-.js";import{P as _}from"./500-Bi-8cWwO.js";import{E as w}from"./empty-B73be7w1.js";import{C as F}from"./combobox-Cboc2YBq.js";import{S as Y}from"./select-multi-xQoT5VS_.js";import{L as J}from"./index-BP3s2TFO.js";import{C as Q,b as U,c as W,d as Z,a as ee}from"./card-B99DATJd.js";import{C as se,A as te,a as ae,X as re,b as le,c as oe,d as ne,e as ie,f as ce}from"./chart-CP_IX_fB.js";import{S as E,a as T,b as A,c as D,d as L}from"./select-oiTXXINI.js";import{a as me}from"./typography-BReC1Yg6.js";import{u as de,a as ue,b as xe}from"./components-BZV9jaWy.js";import{i as pe}from"./isEqual-KSD6Iy0l.js";import"./button-BExhSn8V.js";import"./label-CIvoefGy.js";import"./index-hdGzps5C.js";import"./tslib.es6-DDzNqjJ8.js";import"./index-DN0hhrBY.js";import"./command-BYE4BpMC.js";import"./index-DtQLeWK5.js";import"./index-Bm0JEqyb.js";import"./index-BTG9THwZ.js";import"./index-oFZnn4P-.js";import"./index-Bo1Sjtdr.js";import"./search-G3Oj3KZ-.js";import"./popover-CYP-dzmY.js";import"./index-Cl449RIc.js";import"./index-CBJO-X9V.js";import"./index-BdQq_4o_.js";import"./badge-CojvZVMK.js";import"./check-zjuh9tfK.js";import"./debounce-C-7-H-Ti.js";import"./tiny-invariant-CCoILDQG.js";import"./index-TV27acJk.js";import"./index-k7qIncBC.js";import"./index-By9-dvAW.js";import"./chevron-down-b85u3rlL.js";const I=[{value:"sum",label:"求和"},{value:"avg",label:"平均值"},{value:"max",label:"最大值"},{value:"min",label:"最小值"},{value:"count",label:"计数"}],R=[{value:"7d",label:"最近7天"},{value:"30d",label:"最近30天"},{value:"90d",label:"最近90天"}],he=n.object({db:n.string().default("db1"),model:n.string().min(1,{message:"请选择数据模型"}),fields:n.array(n.object({value:n.string(),label:n.string()})).min(1,{message:"请至少选择一个字段"}),timeRange:n.string().default("7d"),aggregationType:n.string().default("sum")});function as(){const{tables:k=[]}=de(),a=ue(),O=xe();c.useEffect(()=>{a!=null&&a.err&&X.error("获取数据失败",{description:a==null?void 0:a.err})},[a==null?void 0:a.err]);const r=P({resolver:$(he),defaultValues:{db:"db1",model:"Post",fields:[{value:"like",label:"like"},{value:"hit",label:"hit"}],timeRange:R[0].value,aggregationType:I[0].value}}),i=r.watch("model"),l=r.watch("fields"),u=r.watch("timeRange"),b=r.watch("aggregationType"),[m,C]=c.useState([]),[y,V]=c.useState([]);c.useEffect(()=>{if(i){const s=new FormData;s.append("model",i),O(s,{method:"post"})}else C([])},[i,r]),c.useEffect(()=>{const s=(a==null?void 0:a.intFields)||[];if(!pe(s,m)){C(s);const t=s.map(d=>d.value),o=l.filter(d=>t.includes(d.value));r.setValue("fields",o)}},[a==null?void 0:a.intFields,m,r,l]);const G=c.useMemo(()=>{const s=new Date,t=Number(u.replace("d","")),o=new Date(s);return o.setDate(s.getDate()-t),o.setHours(0,0,0,0),o.toISOString()},[u]),M=c.useMemo(()=>{const s=new Date;return s.setHours(23,59,59,999),s.toISOString()},[]),{error:v,isError:N,isFetching:S,isLoading:z}=B({url:"/api/discover",method:"get",config:{query:{resource:i,startDate:G,endDate:M,fields:l.map(s=>s.value).join(","),aggregationType:b}},queryOptions:{enabled:!!i&&!!l.length,queryKey:[l,u,b],onSuccess:({data:s})=>{s&&V(s)}}}),q=()=>{const s={};return l.forEach(t=>{s[t.value]={label:t.label,color:x(t.value)}}),s},x=s=>`hsl(${s.split("").reduce((o,d)=>d.charCodeAt(0)+((o<<5)-o),0)%360}, 70%, 50%)`,H=()=>{const s=q();return e.jsxs(Q,{className:"mt-8 flex flex-1 flex-col",children:[e.jsxs(U,{className:"flex items-center gap-2 space-y-0 border-b py-5 sm:flex-row",children:[e.jsxs("div",{className:"grid flex-1 gap-1 text-center sm:text-left",children:[e.jsxs(W,{className:"capitalize",children:["数据图表 - ",i]}),e.jsx(Z,{children:l.map(t=>t.label).join(", ")||"..."})]}),e.jsxs(E,{value:u,onValueChange:t=>{r.setValue("timeRange",t)},children:[e.jsx(T,{className:"w-[160px] rounded-lg sm:ml-auto","aria-label":"选择时间范围",children:e.jsx(A,{placeholder:"最近90天"})}),e.jsx(D,{className:"rounded-xl",children:R.map(t=>e.jsx(L,{value:t.value,className:"rounded-lg",children:t.label},t.value))})]})]}),e.jsxs(ee,{className:"relative flex-1 px-2 pt-4 sm:px-6 sm:pt-6",children:[S&&e.jsx("div",{className:"absolute flex size-full justify-center",children:e.jsx("div",{className:"flex min-h-40 w-20",children:e.jsx(J,{})})}),!S&&N&&e.jsx("div",{className:"flex h-full min-h-[350px] justify-center",children:e.jsx("div",{className:"flex items-center",children:e.jsx(w,{className:"text-destructive",message:v==null?void 0:v.message})})}),!l.length&&e.jsx("div",{className:"flex h-full min-h-[350px] justify-center",children:e.jsx("div",{className:"flex items-center",children:e.jsx(w,{className:"text-destructive",message:"请选择数据字段"})})}),!z&&y.length!==0&&!N&&!!l.length&&e.jsx(se,{config:s,className:"aspect-auto h-full min-h-[350px] w-full",children:e.jsxs(te,{data:y,children:[e.jsx("defs",{children:l.map(t=>e.jsxs("linearGradient",{id:`fill${t.value}`,x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:x(t.value),stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:x(t.value),stopOpacity:.1})]},t.value))}),e.jsx(ae,{vertical:!1}),e.jsx(re,{dataKey:"date",tickLine:!1,axisLine:!1,tickMargin:8,minTickGap:32,tickFormatter:t=>new Date(t).toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}),e.jsx(le,{cursor:!1,content:e.jsx(oe,{labelFormatter:t=>new Date(t).toLocaleDateString("zh-CN",{month:"short",day:"numeric"}),indicator:"dot"})}),l.map(t=>t.value!=="date"&&t.value!=="createdAt"&&e.jsx(ne,{dataKey:t.value,type:"natural",fill:`url(#fill${t.value})`,stroke:x(t.value),stackId:"a"},t.value)),e.jsx(ie,{content:e.jsx(ce,{})})]})})]})]})};return e.jsxs("div",{className:"flex flex-1 flex-col px-8 pt-8 pb-4",children:[e.jsxs(me,{children:[e.jsx("span",{children:"数据可视化"}),e.jsx("p",{className:"text-muted-foreground text-sm font-normal",children:"选择数据模型、字段和聚合方式，生成动态数据图表（仅限 Int 类型字段）"})]}),e.jsx(K,{...r,children:e.jsxs("form",{className:"mt-8 flex gap-4 *:flex-1",children:[e.jsx(p,{control:r.control,name:"db",render:({field:s})=>e.jsxs(h,{children:[e.jsx(f,{children:"数据源"}),e.jsx(g,{children:e.jsx(F,{className:"sm:w-auto",options:[{label:"数据库 A",value:"db1"},{label:"数据库 B",value:"db2"}],value:s.value,onChange:s.onChange})}),e.jsx(j,{})]})}),e.jsx(p,{control:r.control,name:"model",render:({field:s})=>e.jsxs(h,{children:[e.jsx(f,{children:"数据模型"}),e.jsx(g,{children:e.jsx(F,{className:"sm:w-auto",options:k.sort(),value:s.value,onChange:s.onChange})}),e.jsx(j,{})]})}),i&&e.jsx(p,{control:r.control,name:"fields",render:({field:s})=>e.jsxs(h,{children:[e.jsx(f,{children:"数据字段"}),e.jsx(g,{children:e.jsx(Y,{className:"sm:w-auto md:w-auto",disabled:m.length===0,options:m,value:s.value,onChange:s.onChange,placeholder:m.length===0?"所选数据表暂无数据、或没有可用的 `Int` 类型字段":"选择要展示的字段（支持多选）"})}),e.jsx(j,{})]})}),e.jsx(p,{control:r.control,name:"aggregationType",render:({field:s})=>e.jsxs(h,{children:[e.jsx(f,{children:"聚合方式"}),e.jsxs(E,{onValueChange:s.onChange,defaultValue:s.value,children:[e.jsx(g,{children:e.jsx(T,{children:e.jsx(A,{placeholder:"选择聚合方式"})})}),e.jsx(D,{children:I.map(t=>e.jsx(L,{value:t.value,children:t.label},t.value))})]}),e.jsx(j,{})]})})]})}),H()]})}function rs(){return e.jsx(_,{})}export{rs as ErrorBoundary,as as default};
