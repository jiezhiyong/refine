import{j as o}from"./jsx-runtime-C-_spy54.js";import{t as T}from"./form-EOytp2cR.js";import{a as w}from"./index-hdkCHUwo.js";import{C as N,F as a}from"./field-RlHc_fdj.js";import{r as P}from"./index-aGVi9Z7h.js";import{t as F}from"./index-IcWDtlcJ.js";import{z as p}from"./index-Cb7h-Ku-.js";import{P as A,u as J}from"./500-CvlJQvp0.js";import{C as q}from"./code-BEULcS2d.js";import{C as R}from"./combobox-BWysUI0X.js";import{F as $}from"./form-BJRS087V.js";import{D as B,a as V,b as L,c as U,d as W}from"./dialog-BQdA7G1h.js";import{I as M}from"./input-CWsqa6a4.js";import{E}from"./action-DSYjqVEc.js";import{O as v,p as z}from"./ty-BKnkfqXm.js";import{e as O}from"./axios-DLE8MI3N.js";import{g as G,d as H}from"./get-changed-values-vLde9APN.js";import{g as K}from"./form-BJoh7EuQ.js";import{g as Q}from"./get-default-title-CrVGbO9H.js";import{s as Y}from"./base-Dsx3AJoS.js";import{u as X}from"./components-CzmxjdGq.js";const Z=p.object({projectId:p.string().nonempty({message:"Project is required"}),title:p.string().min(2,{message:void 0}),description:p.string().optional().nullable(),global:p.any().optional().nullable(),pathReplaceProject:p.string().optional().nullable(),pathReplaceModule:p.string().optional().nullable()}),Fe=({matches:e})=>[{title:Q(e)}];function Ce(){const{initialData:e,myIssues:i,projectList:s}=X();return o.jsx(ee,{initialData:e,myIssues:i,projectList:s})}function Pe(){return o.jsx(A,{})}const _=e=>({projectId:(e==null?void 0:e.projectId)||"",title:(e==null?void 0:e.title)||"",description:(e==null?void 0:e.description)||"",global:e!=null&&e.global?JSON.stringify(e==null?void 0:e.global,null,2):"",pathReplaceModule:(e==null?void 0:e.pathReplaceModule)||"",pathReplaceProject:(e==null?void 0:e.pathReplaceProject)||"",issueId:""}),D=Z.extend({issueId:p.string().nonempty({message:"Issue is required"}),global:Y.optional().nullable()}),ee=({className:e,redirect:i=E.list,initialData:s,action:d,myIssues:f=[],projectList:C})=>{var t;const{formAction:b,id:h=s==null?void 0:s.id,identifier:j}=w({action:d}),g=_(s),n=N({resolver:T(D),defaultValues:g,warnWhenUnsavedChanges:!0,mode:"onChange",refineCoreProps:{resource:j,action:b,id:h,queryOptions:K(g),redirect:i}});async function y(r){const{issueId:l,param:u,...m}=r,c={[E.create]:v.ADD,[E.edit]:v.MODIFY},I=z(g,Object.keys(m));I.global&&(I.global=JSON.parse(I.global));const k={operateType:c[b],issueId:l,contentJsonObject:m,configType:"frontRoute",param:u,resource:j,id:s==null?void 0:s.id,data:m,dataPrevious:I},{data:S}=await O.post("/api/ty/deployServiceBuild",k);return S.data}const x=P.useCallback(async r=>{var m;const l=G(r,g);l.global&&(l.global=JSON.parse(l.global));const u=H(l);try{const c=await y({...u,param:`frontRoute:${(m=s==null?void 0:s.project)==null?void 0:m.title}:${r.title}`});return F.success("配置发布申请推送成功",{description:c||"..."}),null}catch(c){throw F.error("配置发布申请执行错误",{description:(c==null?void 0:c.message)||"unknwon"}),c}},[]);return o.jsxs($,{...n,beforeSubmit:x,className:e,recordItemId:s==null?void 0:s.id,children:[o.jsx(a,{...n,name:"projectId",label:"Project",children:o.jsx(R,{options:C.map(r=>({label:r.title,value:r.id}))})}),o.jsx(a,{...n,name:"title",label:"Title",children:o.jsx(M,{})}),o.jsx(a,{...n,name:"pathReplaceModule",label:"Path Replace Module",children:o.jsx(M,{className:"xl:w-1/2"})}),o.jsx(a,{...n,name:"pathReplaceProject",label:"Virtual Path",children:o.jsx(M,{placeholder:(t=s==null?void 0:s.project)==null?void 0:t.title})}),o.jsx(a,{...n,name:"description",label:"Description",children:o.jsx(M,{className:"xl:w-1/2"})}),o.jsx(a,{...n,name:"global",label:"Global",children:o.jsx(q,{language:"json"})}),o.jsx(a,{...n,name:"issueId",label:"IssueId",children:o.jsx(R,{options:f.map(r=>({label:`${r.issueId} - ${r.title}`,value:String(r.issueId)}))})})]})},oe=p.object({issueId:p.string().nonempty({message:"Issue is required"})}),se=({records:e,formModalClose:i,className:s,tableResetRowSelection:d})=>{var y,x;const[f,C]=P.useState([]);J(async()=>{const{data:t}=await O.post("/api/ty/getMyIssues");C(t.data)});const{id:b=(y=e==null?void 0:e[0])==null?void 0:y.id,identifier:h}=w(),j=N({resolver:T(oe),mode:"onChange",warnWhenUnsavedChanges:!1,refineCoreProps:{resource:h,action:E.edit,id:b}});async function g(t){const{issueId:r,param:l,id:u}=t,m={operateType:v.DELETE,issueId:r,contentJsonObject:{},configType:"frontRoute",param:l,resource:h,id:u},{data:c}=await O.post("/api/ty/deployServiceBuild",m);return c.data}const n=P.useCallback(async t=>{try{const r=[];e.forEach(u=>{r.push(g({...t,param:`frontRoute:${u.projectTitle}:${u.title}`,id:u.id}))});const l=await Promise.all(r);F.success("配置发布申请推送成功",{description:l[0]||"..."}),d==null||d()}catch(r){F.error("配置发布申请执行错误",{description:(r==null?void 0:r.message)||"unknwon"})}return null},[]);return o.jsx($,{...j,beforeSubmit:n,className:s,recordItemId:(x=e==null?void 0:e[0])==null?void 0:x.id,formModalClose:i,children:o.jsx(a,{...j,name:"issueId",label:"IssueId",children:o.jsx(R,{popoverProps:{modal:!!i},options:f==null?void 0:f.map(t=>({label:`${t.issueId} - ${t.title}`,value:String(t.issueId)}))})})})};function Re(e){const{visible:i,close:s,records:d,tableResetRowSelection:f}=e;return o.jsx(B,{open:i,onOpenChange:s,children:o.jsxs(V,{children:[o.jsxs(L,{className:"text-destructive border-b pb-4",children:[o.jsx(U,{children:"删除项目"}),o.jsx(W,{children:"请选择关联需求，推送配置发布申请"})]}),o.jsx(se,{className:"p-0",formModalClose:s,records:d,tableResetRowSelection:f})]})})}export{Pe as E,Re as F,ee as a,Ce as b,Fe as m};
