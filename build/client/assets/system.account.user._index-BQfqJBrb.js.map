{"version":3,"file":"system.account.user._index-BQfqJBrb.js","sources":["../../../app/types/user.ts","../../../app/routes/system.account.user._index.tsx"],"sourcesContent":["import { User } from '@prisma/client';\n\nimport { TRole } from '~/constants';\n\nexport type SessionUser = User & { role: TRole; roles: TRole[] };\n\nexport const USER_PROVIDER = {\n  userpass: 'userpass',\n  tcshuke: 'tcshuke',\n} as const;\n","import { User } from '@prisma/client';\nimport { BaseRecord, HttpError, useCan, useDeleteMany, useUserFriendlyName } from '@refinedev/core';\nimport { parseTableParams } from '@refinedev/remix-router';\nimport { LoaderFunctionArgs, MetaFunction } from '@remix-run/node';\nimport { useLoaderData } from '@remix-run/react';\nimport dayjs from 'dayjs';\nimport { useCallback } from 'react';\n\nimport { DeleteButton, ExportButton, ShowButton, Table, TableFilterProps } from '~/component-refine';\nimport { PageError } from '~/components';\nimport { Badge } from '~/components-shadcn/badge';\nimport { Checkbox } from '~/components-shadcn/checkbox';\nimport { EnumAction, EnumResource } from '~/constants';\nimport { type UseTableReturnType } from '~/lib/refinedev-react-table';\nimport { dataService } from '~/services';\nimport { HandleFunction, TAny, USER_PROVIDER } from '~/types';\nimport { getDefaultTitle } from '~/utils';\n\nexport const meta: MetaFunction = ({ matches }) => {\n  return [{ title: getDefaultTitle(matches) }];\n};\n\nexport const handle: HandleFunction = {\n  uiTools: () => {\n    return <UiTools />;\n  },\n};\n\nexport async function loader({ request }: LoaderFunctionArgs) {\n  const url = new URL(request.url);\n  const tableParams = parseTableParams(url.search);\n\n  const data = await dataService.getList<User>({\n    ...tableParams,\n    resource: EnumResource.user,\n    meta: {\n      include: {\n        _count: {\n          select: {\n            Post: true,\n          },\n        },\n      },\n    },\n  });\n\n  return { initialData: data };\n}\n\nexport default function UserIndex() {\n  const { initialData } = useLoaderData<typeof loader>();\n\n  const friendly = useUserFriendlyName();\n  const { mutate: deleteMany } = useDeleteMany();\n  const { data: deletePermission } = useCan({ resource: EnumResource.user, action: EnumAction.delete });\n\n  const bulkDeleteAction = (table: UseTableReturnType<BaseRecord, HttpError>) => {\n    const rows = table.getSelectedRowModel().rows;\n    const label = `Delete Selected (${rows.length}) ${friendly('Row', rows.length > 1 ? 'plural' : 'singular')}`;\n\n    return {\n      className: 'text-destructive!',\n      label,\n      disabled: !deletePermission?.can,\n      onClick: () => {\n        deleteMany(\n          {\n            resource: EnumResource.user,\n            ids: rows.map((row) => row.original.id!),\n          },\n          {\n            onSuccess: () => {\n              table.resetRowSelection();\n            },\n          }\n        );\n      },\n    };\n  };\n\n  return (\n    <Table\n      enableSorting\n      enableFilters\n      enableHiding\n      initialState={{\n        sorting: [\n          {\n            id: 'createdAt',\n            desc: true,\n          },\n        ],\n      }}\n      refineCoreProps={{\n        queryOptions: { initialData },\n        meta: {\n          join: [\n            {\n              field: EnumResource.post,\n              count: true,\n            },\n          ],\n        },\n      }}\n    >\n      <Table.Column\n        accessorKey=\"id\"\n        id=\"id\"\n        header={({ table }) => <Table.CheckAll table={table} options={[bulkDeleteAction(table)]} />}\n        cell={({ row }) => (\n          <Checkbox\n            className=\"ml-2\"\n            checked={row.getIsSelected()}\n            onCheckedChange={(value) => row.toggleSelected(!!value)}\n            aria-label=\"Select row\"\n            key={`checkbox-${row.original.id}`}\n          />\n        )}\n      />\n\n      <Table.Column\n        header=\"Name\"\n        accessorKey=\"name\"\n        id=\"name\"\n        enableHiding\n        meta={{\n          filterOperator: 'contains',\n        }}\n        filter={(props: TableFilterProps) => <Table.Filter.Search {...props} title=\"Search Author\" />}\n        cell={useCallback(\n          ({ row: { index, original }, table }: { row: { index: number; original: BaseRecord }; table: TAny }) => {\n            const pageIndex = table.getState().pagination.pageIndex;\n            const pageSize = table.getState().pagination.pageSize;\n\n            return (\n              <ShowButton recordItemId={original.id} asChild>\n                <span className=\"text-muted-foreground inline-block min-w-8\">\n                  {pageIndex * pageSize + index + 1}.&nbsp;\n                </span>\n\n                <span className=\"py-3 capitalize underline-offset-2 hover:text-green-600 hover:underline\">\n                  {original.name}\n                </span>\n              </ShowButton>\n            );\n          },\n          []\n        )}\n      />\n\n      <Table.Column\n        header=\"Provider\"\n        accessorKey=\"provider\"\n        id=\"provider\"\n        enableSorting\n        enableHiding\n        cell={({ row: { original } }) => {\n          return (\n            <Badge variant=\"outline\">{original.provider?.charAt(0)?.toUpperCase() + original.provider?.slice(1)}</Badge>\n          );\n        }}\n        filter={(props: TableFilterProps) => (\n          <Table.Filter.Radio\n            {...props}\n            options={Object.entries(USER_PROVIDER).map(([key, value]) => ({\n              label: key?.charAt(0)?.toUpperCase() + key?.slice(1),\n              value,\n            }))}\n          />\n        )}\n      />\n\n      <Table.Column\n        header=\"CreatedAt\"\n        accessorKey=\"createdAt\"\n        id=\"createdAt\"\n        enableSorting\n        enableHiding\n        filter={(props: TableFilterProps) => <Table.Filter.DateRangePicker {...props} align=\"end\" />}\n        cell={({ row: { original } }) => dayjs(original.createdAt).format('YYYY-MM-DD HH:mm:ss')}\n      />\n\n      <Table.Column\n        header=\"Actions\"\n        accessorKey=\"id\"\n        id=\"actions\"\n        cell={({ row: { original } }: { row: { original: BaseRecord } }) => (\n          <DeleteButton recordItemId={original.id} size=\"icon\" variant=\"ghost\" className=\"text-destructive!\" />\n        )}\n      />\n    </Table>\n  );\n}\n\nfunction UiTools() {\n  return (\n    <div className=\"flex items-center gap-1 text-sm\">\n      <ExportButton variant=\"ghost\" size=\"icon\" />\n    </div>\n  );\n}\n\n// 错误边界处理\nexport function ErrorBoundary() {\n  return <PageError />;\n}\n"],"names":["USER_PROVIDER","meta","matches","title","getDefaultTitle","handle","uiTools","UiTools","UserIndex","initialData","useLoaderData","friendly","useUserFriendlyName","mutate","deleteMany","useDeleteMany","data","deletePermission","useCan","resource","EnumResource","user","action","EnumAction","delete","bulkDeleteAction","table","rows","getSelectedRowModel","className","label","length","disabled","can","onClick","ids","map","row","original","id","onSuccess","resetRowSelection","jsxs","Table","enableSorting","enableFilters","enableHiding","initialState","sorting","desc","refineCoreProps","queryOptions","join","field","post","count","children","jsx","Column","accessorKey","header","CheckAll","options","cell","Checkbox","checked","getIsSelected","onCheckedChange","value","toggleSelected","filterOperator","filter","props","Filter","Search","useCallback","index","pageIndex","getState","pagination","pageSize","ShowButton","recordItemId","asChild","name","Badge","variant","provider","charAt","toUpperCase","slice","Radio","Object","entries","key","DateRangePicker","align","dayjs","createdAt","format","DeleteButton","size","ExportButton","ErrorBoundary","PageError"],"mappings":"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"}