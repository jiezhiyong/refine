import{j as e}from"./jsx-runtime-C-_spy54.js";import{k as Z}from"./index-hdkCHUwo.js";import{r as i}from"./index-aGVi9Z7h.js";import{t as G}from"./index-IcWDtlcJ.js";import{u as ve,t as be,f as Ce,a as we,b as $,c as F,d as I,F as O,e as B}from"./form-EOytp2cR.js";import{z as D}from"./index-Cb7h-Ku-.js";import{C as Ne}from"./combobox-BWysUI0X.js";import{B as V,c as W}from"./button-8zOaFnqZ.js";import{D as Ae,a as Se,b as De,c as ke,d as ye,f as Me}from"./dialog-BQdA7G1h.js";import{I as K}from"./input-CWsqa6a4.js";import{S as R,u as le,a as ce,D as oe,c as de,r as he,b as ue,v as fe,d as xe,e as pe,f as me,P as je}from"./switch-ClZeFjjv.js";import{m as Ie,s as se,n as Ee,t as Le,P as Te,e as $e,u as Fe}from"./lucide-icons-Cs_6wGxK.js";import{t as J}from"./i18next-BaiEmIpz.js";import{D as Oe}from"./dynamic-icon-B2CUf8En.js";import{C as Ve,b as ze}from"./card-BavCCNFE.js";import{c as Q,T as U,a as X,b as Y}from"./tooltip-dCS1zgo4.js";import{c as ae}from"./resources-nPXTaVLM.js";import{E as _}from"./action-DSYjqVEc.js";import{E as ee}from"./resource-BEg55So-.js";import{L as He}from"./index-BlMPtN9h.js";import{A as Pe,b as Re,c as Be,d as Je,e as Ge,f as We,g as qe,h as Ke}from"./alert-dialog-BBz2U9GM.js";import{a as Qe}from"./typography-BLrnCGnf.js";import{u as Ue,a as Xe,b as Ye}from"./components-CzmxjdGq.js";import"./label-CGr_cgmC.js";import"./index-BJ0lhZ-K.js";import"./command-DoxM3uwe.js";import"./index-BEBrh2Va.js";import"./index-BU-I6paI.js";import"./index-BTG9THwZ.js";import"./index-oFZnn4P-.js";import"./index-CmlQ-bcy.js";import"./tslib.es6-DDzNqjJ8.js";import"./popover-Cif6mCbD.js";import"./index-bUQLM8l5.js";import"./index-CBJO-X9V.js";import"./index-BdQq_4o_.js";import"./index-k7qIncBC.js";import"./preload-helper-D7HrI6pR.js";import"./index-CabYiTh8.js";import"./index-DN0hhrBY.js";function re(r){switch(r){case 0:return"一级菜单";case 1:return"二级菜单";case 2:return"三级菜单";case 3:return"四级菜单";default:return`${r+1}级菜单`}}const Ze=D.object({id:D.string().optional(),name:D.string().min(1,"菜单名称不能为空"),title:D.string().optional(),parentId:D.string().nullable().optional(),isActive:D.boolean().default(!0),list:D.string().optional(),create:D.string().optional(),edit:D.string().optional(),show:D.string().optional(),clone:D.string().optional(),isActiveList:D.boolean().default(!0),isActiveCreate:D.boolean().default(!1),isActiveEdit:D.boolean().default(!1),isActiveShow:D.boolean().default(!1),isActiveClone:D.boolean().default(!1),icon:D.string().optional()});function _e({open:r,onOpenChange:o,onClose:m,onSuccess:d,onSave:j,menu:a,menus:u}){const g=!!a,n=ve({resolver:be(Ze),defaultValues:{id:"",name:"",title:"",parentId:null,isActive:!0,list:"",create:"",edit:"",show:"",clone:"",isActiveList:!0,isActiveCreate:!1,isActiveEdit:!1,isActiveShow:!1,isActiveClone:!1,icon:""}}),v=n.watch("name"),x=n.watch("parentId"),C=Ce({control:n.control,name:["list","create","edit","show","clone"]}),N=i.useMemo(()=>{const s=[];return u.forEach(t=>{var h;(h=t.meta)!=null&&h.parent||s.push({id:t.id,name:t.name,title:t.title||t.name,level:0})}),u.forEach(t=>{var h,S;(h=t.meta)!=null&&h.parent&&((S=t.meta)!=null&&S.icon)&&u.find(w=>{var k;return w.name===((k=t.meta)==null?void 0:k.parent)})&&s.push({id:t.id,name:t.name,title:t.title||t.name,level:1})}),s},[u]),l=i.useMemo(()=>{if(!x)return-1;const s=N.find(t=>t.id===x);return s?s.level:-1},[x,N]);i.useEffect(()=>{var s,t;if(a){let h=null;if((s=a.meta)!=null&&s.parent){const H=a.meta.parent,p=u.find(f=>f.name===H);p&&(h=p.id)}const S=!!a.list,b=!!a.create,w=!!a.edit,k=!!a.show,y=!!a.clone;n.reset({id:a.id,name:a.name,title:a.title||"",parentId:h,isActive:a.isActive??!0,list:a.list||"",create:a.create||"",edit:a.edit||"",show:a.show||"",clone:a.clone||"",isActiveList:S,isActiveCreate:b,isActiveEdit:w,isActiveShow:k,isActiveClone:y,icon:((t=a.meta)==null?void 0:t.icon)||""})}else n.reset({id:"",name:"",title:"",parentId:null,isActive:!0,list:"",create:"",edit:"",show:"",clone:"",isActiveList:!0,isActiveCreate:!1,isActiveEdit:!1,isActiveShow:!1,isActiveClone:!1,icon:""})},[a,u,n]),i.useEffect(()=>{var s;l===0?n.setValue("icon",((s=a==null?void 0:a.meta)==null?void 0:s.icon)||"Lightbulb"):l!==0&&n.setValue("icon","")},[l,n,a]);const M=i.useCallback(()=>{var h,S;if(!v)return{list:"",create:"",edit:"",show:"",clone:""};const s=[];if(x){const b=N.find(w=>w.id===x);if(!b)return{list:"",create:"",edit:"",show:"",clone:""};if(b.level===0)s.push(b.name);else if(b.level===1){const w=(S=(h=u.find(k=>k.id===b.id))==null?void 0:h.meta)==null?void 0:S.parent;if(w){const k=u.find(y=>y.name===w);k&&s.push(k.name)}s.push(b.name)}}s.push(v);const t=`/${s.join("/")}`;return{list:t,create:`${t}/create`,edit:`${t}/edit/:id`,show:`${t}/show/:id`,clone:`${t}/clone/:id`}},[v,x,N,u]);i.useEffect(()=>{const s=M();n.setValue("list",s.list),n.setValue("create",s.create),n.setValue("edit",s.edit),n.setValue("show",s.show),n.setValue("clone",s.clone)},[n,M,v,x]);const A=i.useCallback(s=>{const t={...s,list:s.isActiveList?s.list:void 0,create:s.isActiveCreate?s.create:void 0,edit:s.isActiveEdit?s.edit:void 0,show:s.isActiveShow?s.show:void 0,clone:s.isActiveClone?s.clone:void 0,icon:l===0?s.icon:void 0};j?j(g&&a?{...t,id:a.id}:t):(G.success(g?"菜单更新成功":"菜单创建成功"),d())},[g,a,j,d,l]),c=n.formState.isSubmitting;return e.jsx(Ae,{open:r,onOpenChange:o,children:e.jsxs(Se,{className:"sm:max-w-[800px]",children:[e.jsxs(De,{children:[e.jsx(ke,{children:g?"编辑菜单":"新增菜单"}),e.jsx(ye,{})]}),e.jsx(we,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(A),className:"space-y-6",children:[e.jsx($,{control:n.control,name:"parentId",render:({field:s})=>e.jsxs(F,{className:"flex-1",children:[e.jsx(I,{children:"父级菜单"}),e.jsx(O,{children:e.jsx(Ne,{options:[{value:"null",label:"无 (作为一级菜单)"},...N.map(t=>({value:t.id,label:`${re(t.level)} - ${t.title}`}))],placeholder:"选择父级菜单",value:s.value===null?"null":s.value||"",onChange:t=>s.onChange(t==="null"?null:t),disabled:n.formState.isSubmitting,popoverProps:{modal:!0}})}),e.jsx(B,{})]})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx($,{control:n.control,name:"name",render:({field:s})=>e.jsxs(F,{className:"flex-1",children:[e.jsxs(I,{children:["菜单名称, 当前菜单级别：",re(l+1)]}),e.jsx(O,{children:e.jsx(K,{placeholder:"请输入菜单名称",...s})}),e.jsx(B,{})]})}),e.jsx($,{control:n.control,name:"title",render:({field:s})=>e.jsxs(F,{className:"flex-1",children:[e.jsx(I,{children:"菜单标题"}),e.jsx(O,{children:e.jsx(K,{placeholder:"请输入菜单标题",...s})}),e.jsx(B,{})]})}),e.jsx($,{control:n.control,name:"icon",render:({field:s})=>e.jsxs(F,{children:[e.jsx(I,{children:"菜单图标"}),e.jsx(O,{children:e.jsx(K,{...s,placeholder:l!==0?"仅限二级菜单可设置图标":"请输入图标名称",disabled:l!==0||n.formState.isSubmitting})}),e.jsx(B,{})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{control:n.control,name:"isActiveList",render:({field:s})=>e.jsxs(F,{className:"flex flex-row items-center justify-between rounded-lg border p-3",children:[e.jsx(I,{className:"flex-1",children:C[0]||"N/A"}),e.jsx(I,{children:"列表"}),e.jsx(O,{children:e.jsx(R,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx($,{control:n.control,name:"isActiveCreate",render:({field:s})=>e.jsxs(F,{className:"flex flex-row items-center justify-between rounded-lg border p-3",children:[e.jsx(I,{className:"flex-1",children:C[1]||"N/A"}),e.jsx(I,{children:"创建"}),e.jsx(O,{children:e.jsx(R,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx($,{control:n.control,name:"isActiveEdit",render:({field:s})=>e.jsxs(F,{className:"flex flex-row items-center justify-between rounded-lg border p-3",children:[e.jsx(I,{className:"flex-1",children:C[2]||"N/A"}),e.jsx(I,{children:"编辑"}),e.jsx(O,{children:e.jsx(R,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx($,{control:n.control,name:"isActiveShow",render:({field:s})=>e.jsxs(F,{className:"flex flex-row items-center justify-between rounded-lg border p-3",children:[e.jsx(I,{className:"flex-1",children:C[3]||"N/A"}),e.jsx(I,{children:"详情"}),e.jsx(O,{children:e.jsx(R,{checked:s.value,onCheckedChange:s.onChange})})]})}),e.jsx($,{control:n.control,name:"isActiveClone",render:({field:s})=>e.jsxs(F,{className:"flex flex-row items-center justify-between rounded-lg border p-3",children:[e.jsx(I,{className:"flex-1",children:C[4]||"N/A"}),e.jsx(I,{children:"克隆"}),e.jsx(O,{children:e.jsx(R,{checked:s.value,onCheckedChange:s.onChange})})]})})]}),e.jsxs(Me,{children:[e.jsx(V,{type:"button",variant:"outline",onClick:m,children:"取消"}),e.jsx(V,{type:"submit",disabled:c,icon:e.jsx(Ie,{}),children:c?"保存中...":"保存"})]})]})})]})})}function es({items:r,onEditMenu:o,onDeleteMenu:m,onReorder:d,onToggleActive:j}){const[a,u]=i.useState(null),g=i.useMemo(()=>{var c;const l=new Set,A=r.filter(s=>{var t;return!((t=s.meta)!=null&&t.parent)})[0];if(A){l.add(A.id);const s=(c=A.children)==null?void 0:c[0];s&&l.add(s.id)}return l},[r]),[n,v]=i.useState(g),x=le(ce(je,{activationConstraint:{distance:5}})),C=i.useCallback(l=>{v(M=>{const A=new Set(M);return A.has(l)?A.delete(l):A.add(l),A})},[]);return i.useCallback(()=>{const l=r.filter(s=>{var t;return!((t=s.meta)!=null&&t.parent)}),M=l.map(s=>s.id),A=s=>{const{active:t,over:h}=s;if(h&&t.id!==h.id){const S=l.findIndex(w=>w.id===t.id),b=l.findIndex(w=>w.id===h.id);if(S!==-1&&b!==-1){const w=me(l,S,b);d([...w,...r.filter(k=>{var y;return(y=k.meta)==null?void 0:y.parent})])}}u(null)},c=s=>{const{active:t}=s,h=l.find(S=>S.id===t.id);h&&u(h)};return e.jsxs(oe,{sensors:x,collisionDetection:de,onDragStart:c,onDragEnd:A,modifiers:[he],children:[e.jsx(ue,{items:M,strategy:fe,children:e.jsx("div",{className:"space-y-2",children:l.map(s=>e.jsx(ss,{item:s,onEdit:o,onDelete:m,onToggle:C,expanded:n.has(s.id),onToggleActive:j,expandedItems:n,onReorder:d,allItems:r},s.id))})}),e.jsx(xe,{adjustScale:!1,dropAnimation:null,children:a&&e.jsx(te,{item:a,onEdit:o,onDelete:m,onToggle:C,expanded:!1,dragHandle:e.jsx(V,{variant:"ghost",size:"icon",className:"h-8 w-8 cursor-grab",children:e.jsx(se,{className:"h-4 w-4"})}),onToggleActive:j})})]})},[n,C,r,m,o,d,j,x,a])()}function te({item:r,onEdit:o,onDelete:m,onToggle:d,expanded:j,dragHandle:a,onToggleActive:u}){var x;const g=r.children&&r.children.length>0,{data:n}=Z({resource:ee.menu,action:_.edit}),{data:v}=Z({resource:ee.menu,action:_.delete});return e.jsx(Ve,{className:W("overflow-hidden border transition-all",!r.isActive&&"border-dashed opacity-70"),children:e.jsx(ze,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[g&&e.jsx(V,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>d(r.id),children:j?e.jsx(Ee,{className:"h-4 w-4 text-green-500"}):e.jsx(Le,{className:"h-4 w-4"})}),e.jsxs("div",{className:"ml-2 flex items-center gap-2",children:[((x=r.meta)==null?void 0:x.icon)&&e.jsx(Oe,{name:r.meta.icon,className:"text-muted-foreground h-4 w-4"}),e.jsxs("span",{className:"font-medium",children:[J(`menus.${r.name}`,r.title||"?")," - ",r.name]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[u&&e.jsx(Q,{children:e.jsxs(U,{children:[e.jsx(X,{asChild:!0,children:e.jsx("div",{children:e.jsx(R,{id:`active-${r.id}`,checked:r.isActive!==!1,onCheckedChange:C=>u(r,C),disabled:!(n!=null&&n.can)||ae.includes(r.name)})})}),e.jsx(Y,{children:e.jsx("p",{children:J("buttons.activeToggle")})})]})}),e.jsx(Q,{children:e.jsxs(U,{children:[e.jsx(X,{asChild:!0,children:e.jsx(V,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>o(r),disabled:!(n!=null&&n.can),children:e.jsx(Te,{className:"h-4 w-4"})})}),e.jsx(Y,{children:e.jsx("p",{children:J("buttons.edit")})})]})}),m&&e.jsx(Q,{children:e.jsxs(U,{children:[e.jsx(X,{asChild:!0,children:e.jsx(V,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>m(r),disabled:!(v!=null&&v.can)||ae.includes(r.name),children:e.jsx($e,{className:"text-destructive h-4 w-4"})})}),e.jsx(Y,{children:e.jsx("p",{children:J("buttons.delete")})})]})}),e.jsx("div",{className:W(!(n!=null&&n.can)&&"pointer-events-none opacity-50"),children:a})]})]})})})}function ss({item:r,onEdit:o,onDelete:m,onToggle:d,expanded:j,onToggleActive:a,expandedItems:u,onReorder:g,allItems:n}){const{attributes:v,listeners:x,setNodeRef:C,transform:N,transition:l,isDragging:M}=pe({id:r.id}),A={transform:N?`translate3d(${N.x}px, ${N.y}px, 0)`:void 0,transition:l},c=e.jsx(V,{variant:"ghost",size:"icon",className:"h-8 w-8 cursor-grab",...v,...x,children:e.jsx(se,{className:"h-4 w-4"})});return e.jsxs("div",{ref:C,style:A,className:W(M&&"opacity-50"),children:[e.jsx(te,{item:r,onEdit:o,onDelete:m,onToggle:d,expanded:j,dragHandle:c,onToggleActive:a}),j&&r.children&&r.children.length>0&&e.jsx("div",{className:"mt-2 ml-7 space-y-2 border-l pl-4",children:e.jsx(ge,{parentId:r.id,items:r.children,onEdit:o,onDelete:m,onToggle:d,expandedItems:u,onToggleActive:a,onReorder:g,allItems:n})})]})}function ge({parentId:r,items:o,onEdit:m,onDelete:d,onToggle:j,expandedItems:a,onToggleActive:u,onReorder:g,allItems:n}){const[v,x]=i.useState(null),C=le(ce(je,{activationConstraint:{distance:5}})),N=i.useMemo(()=>o.map(c=>c.id),[o]),l=i.useCallback(c=>{const{active:s}=c,t=o.find(h=>h.id===s.id);t&&x(t)},[o]),M=i.useCallback(c=>{const{active:s,over:t}=c;if(t&&s.id!==t.id){const h=o.findIndex(b=>b.id===s.id),S=o.findIndex(b=>b.id===t.id);if(h!==-1&&S!==-1){const b=me(o,h,S),w=[...n],k=(y,H,p)=>{for(let f=0;f<y.length;f++){if(y[f].id===H)return y[f]={...y[f],children:[...p]},!0;if(y[f].children&&k(y[f].children||[],H,p))return!0}return!1};k(w,r,b),g(w)}}x(null)},[o,n,g,r]),A=i.useCallback(c=>{const s=c.children&&c.children.length>0,t=a.has(c.id);return e.jsx(ie,{item:c,onEdit:m,onDelete:d,onToggle:j,expanded:t,onToggleActive:u,expandedItems:a,children:s&&t&&e.jsx("div",{className:"mt-2 ml-7 space-y-2 border-l pl-4",children:e.jsx(ge,{parentId:c.id,items:c.children||[],onEdit:m,onDelete:d,onToggle:j,expandedItems:a,onToggleActive:u,onReorder:g,allItems:n})})},c.id)},[a,d,m,g,j,u,n]);return e.jsxs(oe,{sensors:C,collisionDetection:de,onDragStart:l,onDragEnd:M,modifiers:[he],children:[e.jsx(ue,{items:N,strategy:fe,children:e.jsx("div",{className:"space-y-2",children:o.map(c=>A(c))})}),e.jsx(xe,{children:v&&e.jsx(ie,{item:v,onEdit:m,onDelete:d,onToggle:j,expanded:a.has(v.id),onToggleActive:u,expandedItems:a})})]})}function ie({item:r,onEdit:o,onDelete:m,onToggle:d,expanded:j,onToggleActive:a,children:u}){const{attributes:g,listeners:n,setNodeRef:v,transform:x,transition:C,isDragging:N}=pe({id:r.id}),l={transform:x?`translate3d(${x.x}px, ${x.y}px, 0)`:void 0,transition:C},M=e.jsx(V,{variant:"ghost",size:"icon",className:"h-8 w-8 cursor-grab",...g,...n,children:e.jsx(se,{className:"h-4 w-4"})});return e.jsxs("div",{ref:v,style:l,className:W(N&&"opacity-50"),children:[e.jsx(te,{item:r,onEdit:o,onDelete:m,onToggle:d,expanded:j,dragHandle:M,onToggleActive:a}),u]})}function Bs(){var y,H;const r=Ue(),o=Xe(),m=i.useMemo(()=>"menus"in r?r.menus:[],[r]),d=Ye(),[j,a]=i.useState(!1),[u,g]=i.useState(null),[n,v]=i.useState([]),[x,C]=i.useState(!0),{data:N}=Z({resource:ee.menu,action:_.create});i.useEffect(()=>{if(!m.length)return;v((f=>{const L=(T,E)=>f.filter(P=>{var q,ne;return E===0?!((q=P.meta)!=null&&q.parent):((ne=P.meta)==null?void 0:ne.parent)===T}).map(P=>({...P,level:E,children:L(P.name,E+1)}));return L(null,0)})(m)),C(!1)},[m]),i.useEffect(()=>{o&&(o.error?G.error("菜单操作失败",{description:o.error}):o.success&&G.success("菜单操作成功"))},[o]);const l=i.useCallback(async p=>{const f=T=>{const E=[];return T.forEach((z,P)=>{E.push({...z,order:P}),z.children&&z.children.length>0&&E.push(...f(z.children))}),E},L=f(p);try{const T=L.map(z=>({id:z.id,order:z.order||0})),E=new FormData;E.append("action","updateOrder"),E.append("updates",JSON.stringify(T)),d(E,{method:"post"}),v(p)}catch(T){console.error("更新菜单排序失败",T),G.error(`更新失败: ${T instanceof Error?T.message:"未知错误"}`)}},[d]),M=i.useCallback(p=>{g(p),a(!0)},[]),A=i.useCallback(()=>{g(null),a(!0)},[]),[c,s]=i.useState({isOpen:!1,menu:null}),t=i.useCallback(p=>{s({isOpen:!0,menu:p})},[]),h=i.useCallback(()=>{s({isOpen:!1,menu:null})},[]),S=i.useCallback(()=>{const{menu:p}=c;if(!p)return;const f=new FormData;f.append("action","delete"),f.append("id",p.id),d(f,{method:"post"}),h()},[c,d,h]),b=i.useCallback(()=>{a(!1),g(null)},[]),w=i.useCallback(p=>{const f=new FormData;p.id?f.append("action","update"):f.append("action","create"),f.append("menu",JSON.stringify(p)),d(f,{method:"post"}),a(!1),g(null)},[d]),k=i.useCallback((p,f)=>{const L=new FormData;L.append("action","toggleActive"),L.append("id",p.id),L.append("name",p.name),L.append("isActive",String(f)),d(L,{method:"post"})},[d]);return e.jsxs("div",{className:"flex flex-1 flex-col px-8 pt-8 pb-4",children:[e.jsxs(Qe,{className:"mb-6 flex items-center justify-between",children:[e.jsx("span",{children:"菜单管理"}),e.jsxs(V,{onClick:A,disabled:!(N!=null&&N.can),children:[e.jsx(Fe,{className:"h-4 w-4"}),"添加菜单"]})]}),x?e.jsx("div",{className:"flex size-full justify-center",children:e.jsx("div",{className:"flex w-20",children:e.jsx(He,{})})}):e.jsx("div",{className:"space-y-4",children:n.length===0?e.jsx("div",{className:"text-muted-foreground py-8 text-center",children:"暂无菜单，请点击右上角添加菜单按钮创建"}):e.jsx(es,{items:n,onReorder:l,onEditMenu:M,onDeleteMenu:t,onToggleActive:k})}),e.jsx(_e,{open:j,onOpenChange:a,onClose:()=>a(!1),onSuccess:b,onSave:w,menu:u,menus:m}),e.jsx(Pe,{open:c.isOpen,onOpenChange:p=>!p&&h(),children:e.jsxs(Re,{children:[e.jsxs(Be,{children:[e.jsx(Je,{children:"确认删除菜单"}),e.jsxs(Ge,{children:["确定要删除菜单“",((y=c.menu)==null?void 0:y.title)||((H=c.menu)==null?void 0:H.name),"”吗？此操作不可撤销。"]})]}),e.jsxs(We,{children:[e.jsx(qe,{children:"取消"}),e.jsx(Ke,{onClick:S,variant:"destructive",children:"确认删除"})]})]})})]})}export{Bs as default};
