{"version":3,"file":"system.admin.log._index-AYPT_4A3.js","sources":["../../../app/routes/system.admin.log._index.tsx"],"sourcesContent":["import { Post } from '@prisma/client';\nimport { BaseRecord, HttpError, useCan, useDeleteMany, useUserFriendlyName } from '@refinedev/core';\nimport { parseTableParams } from '@refinedev/remix-router';\nimport { LoaderFunctionArgs, MetaFunction } from '@remix-run/node';\nimport { useLoaderData } from '@remix-run/react';\nimport dayjs from 'dayjs';\nimport { useCallback } from 'react';\n\nimport { ExportButton, ShowButton, Table, TableFilterProps } from '~/component-refine';\nimport { PageError } from '~/components';\nimport { Avatar, AvatarFallback, AvatarImage } from '~/components-shadcn/avatar';\nimport { Badge } from '~/components-shadcn/badge';\nimport { Checkbox } from '~/components-shadcn/checkbox';\nimport { EnumAction, EnumResource } from '~/constants';\nimport { type UseTableReturnType } from '~/lib/refinedev-react-table';\nimport { dataService } from '~/services';\nimport { HandleFunction, LOG_STATUS, LOG_STATUS_MAP, LogStatus, TAny } from '~/types';\nimport { getDefaultTitle } from '~/utils';\n\nexport const meta: MetaFunction = ({ matches }) => {\n  return [{ title: getDefaultTitle(matches) }];\n};\n\nexport const handle: HandleFunction = {\n  uiTools: () => {\n    return <UiTools />;\n  },\n};\n\nexport async function loader({ request }: LoaderFunctionArgs) {\n  const url = new URL(request.url);\n  const tableParams = parseTableParams(url.search);\n\n  const data = await dataService.getList<Post>({\n    ...tableParams,\n    resource: EnumResource.log,\n    meta: {\n      include: {\n        user: { select: { name: true, avatar: true } },\n      },\n    },\n  });\n\n  return { initialData: data };\n}\n\nexport default function LogIndex() {\n  const { initialData } = useLoaderData<typeof loader>();\n\n  const friendly = useUserFriendlyName();\n  const { mutate: deleteMany } = useDeleteMany();\n  const { data: deletePermission } = useCan({ resource: EnumResource.log, action: EnumAction.delete });\n\n  const bulkDeleteAction = (table: UseTableReturnType<BaseRecord, HttpError>) => {\n    const rows = table.getSelectedRowModel().rows;\n    const label = `Delete Selected (${rows.length}) ${friendly('Row', rows.length > 1 ? 'plural' : 'singular')}`;\n\n    return {\n      className: 'text-destructive!',\n      label,\n      disabled: !deletePermission?.can,\n      onClick: () => {\n        deleteMany(\n          {\n            resource: EnumResource.log,\n            ids: rows.map((row) => row.original.id!),\n          },\n          {\n            onSuccess: () => {\n              table.resetRowSelection();\n            },\n          }\n        );\n      },\n    };\n  };\n\n  return (\n    <Table\n      enableSorting\n      enableFilters\n      enableHiding\n      initialState={{\n        sorting: [\n          {\n            id: 'createdAt',\n            desc: true,\n          },\n        ],\n      }}\n      refineCoreProps={{\n        queryOptions: { initialData },\n        meta: {\n          join: [\n            {\n              field: EnumResource.user,\n              select: ['name', 'avatar'],\n            },\n          ],\n        },\n      }}\n    >\n      <Table.Column\n        accessorKey=\"id\"\n        id=\"id\"\n        header={({ table }) => <Table.CheckAll table={table} options={[bulkDeleteAction(table)]} />}\n        cell={({ row }) => (\n          <Checkbox\n            className=\"ml-2\"\n            checked={row.getIsSelected()}\n            onCheckedChange={(value) => row.toggleSelected(!!value)}\n            aria-label=\"Select row\"\n            key={`checkbox-${row.original.id}`}\n          />\n        )}\n      />\n\n      <Table.Column\n        header=\"Resource\"\n        accessorKey=\"resource\"\n        id=\"resource\"\n        meta={{\n          filterOperator: 'contains',\n        }}\n        filter={(props: TableFilterProps) => <Table.Filter.Search {...props} title=\"Search Resource\" />}\n        cell={({ row: { index, original }, table }) => {\n          const pageIndex = table.getState().pagination.pageIndex;\n          const pageSize = table.getState().pagination.pageSize;\n\n          return (\n            <ShowButton recordItemId={original.id} asChild>\n              <span className=\"text-muted-foreground inline-block min-w-8\">\n                {pageIndex * pageSize + index + 1}.&nbsp;\n              </span>\n              <span className=\"py-3 capitalize underline-offset-2 hover:text-green-600 hover:underline\">\n                {JSON.parse(original.meta).parent}.{original.resource}\n              </span>\n            </ShowButton>\n          );\n        }}\n      />\n\n      <Table.Column\n        header=\"Type\"\n        accessorKey=\"action\"\n        id=\"action\"\n        enableSorting\n        enableHiding\n        cell={({ row: { original } }) => {\n          const ids = JSON.parse(original.meta || '{}').ids;\n          return (\n            <Badge variant={LOG_STATUS_MAP[original.action as LogStatus]?.badge as TAny}>\n              {original.action?.charAt(0)?.toUpperCase() + original.action?.slice(1)}\n              {ids?.length > 1 ? ` x${ids.length}` : ''}\n            </Badge>\n          );\n        }}\n        filter={(props: TableFilterProps) => (\n          <Table.Filter.Radio\n            {...props}\n            options={Object.entries(LOG_STATUS).map(([key, value]) => ({\n              label: key?.charAt(0)?.toUpperCase() + key?.slice(1),\n              value,\n            }))}\n          />\n        )}\n      />\n\n      <Table.Column\n        header=\"CreatedAt\"\n        accessorKey=\"createdAt\"\n        id=\"createdAt\"\n        enableSorting\n        enableHiding\n        filter={(props: TableFilterProps) => <Table.Filter.DateRangePicker {...props} align=\"end\" />}\n        cell={({ row: { original } }) => dayjs(original.createdAt).format('YYYY-MM-DD HH:mm:ss')}\n      />\n\n      <Table.Column\n        header=\"Author\"\n        accessorKey=\"user.name\"\n        id=\"user.name\"\n        enableHiding\n        meta={{\n          filterOperator: 'contains',\n        }}\n        filter={(props: TableFilterProps) => <Table.Filter.Search {...props} title=\"Search Author\" />}\n        cell={useCallback(\n          ({ row: { original } }: { row: { original: BaseRecord } }) => (\n            <div className=\"flex items-center gap-2\">\n              <Avatar className=\"size-6\">\n                <AvatarImage src={original.user?.avatar || ''} alt={original.user?.name || ''} />\n                <AvatarFallback>{original.user?.name?.slice(0, 1).toUpperCase()}</AvatarFallback>\n              </Avatar>\n              <span>{original.user?.name}</span>\n            </div>\n          ),\n          []\n        )}\n      />\n\n      <Table.Column\n        header=\"Actions\"\n        accessorKey=\"id\"\n        id=\"actions\"\n        cell={({ row: { original } }: { row: { original: BaseRecord } }) => (\n          <ShowButton recordItemId={original.id} size=\"icon\" variant=\"ghost\" />\n        )}\n      />\n    </Table>\n  );\n}\n\nfunction UiTools() {\n  return (\n    <div className=\"flex items-center gap-1 text-sm\">\n      <ExportButton variant=\"ghost\" size=\"icon\" />\n    </div>\n  );\n}\n\n// 错误边界处理\nexport function ErrorBoundary() {\n  return <PageError />;\n}\n"],"names":["meta","matches","title","getDefaultTitle","handle","uiTools","UiTools","LogIndex","initialData","useLoaderData","friendly","useUserFriendlyName","mutate","deleteMany","useDeleteMany","data","deletePermission","useCan","resource","EnumResource","log","action","EnumAction","delete","bulkDeleteAction","table","rows","getSelectedRowModel","className","label","length","disabled","can","onClick","ids","map","row","original","id","onSuccess","resetRowSelection","jsxs","Table","enableSorting","enableFilters","enableHiding","initialState","sorting","desc","refineCoreProps","queryOptions","join","field","user","select","children","jsx","Column","accessorKey","header","CheckAll","options","cell","Checkbox","checked","getIsSelected","onCheckedChange","value","toggleSelected","filterOperator","filter","props","Filter","Search","index","pageIndex","getState","pagination","pageSize","ShowButton","recordItemId","asChild","JSON","parse","parent","Badge","variant","LOG_STATUS_MAP","badge","charAt","toUpperCase","slice","Radio","Object","entries","LOG_STATUS","key","DateRangePicker","align","dayjs","createdAt","format","useCallback","Avatar","AvatarImage","src","avatar","alt","name","AvatarFallback","size","ExportButton","ErrorBoundary","PageError"],"mappings":"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"}