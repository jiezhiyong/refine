{"version":3,"file":"system.account.role._index-x_hKVZ87.js","sources":["../../../app/routes/system.account.role._index.tsx"],"sourcesContent":["import { Role } from '@prisma/client';\nimport { BaseRecord, HttpError, useCan, useDeleteMany, useUserFriendlyName } from '@refinedev/core';\nimport { parseTableParams } from '@refinedev/remix-router';\nimport { LoaderFunctionArgs, MetaFunction } from '@remix-run/node';\nimport { useLoaderData } from '@remix-run/react';\nimport dayjs from 'dayjs';\nimport { useCallback } from 'react';\n\nimport { ExportButton, ShowButton } from '~/component-refine';\nimport { Table, TableFilterProps } from '~/component-refine/table';\nimport { PageError } from '~/components';\nimport { Avatar, AvatarFallback, AvatarImage } from '~/components-shadcn/avatar';\nimport { Checkbox } from '~/components-shadcn/checkbox';\nimport { EnumAction, EnumResource } from '~/constants';\nimport { type UseTableReturnType } from '~/lib/refinedev-react-table';\nimport { dataService } from '~/services';\nimport { HandleFunction } from '~/types';\nimport { getDefaultTitle } from '~/utils';\n\nexport const meta: MetaFunction = ({ matches }) => {\n  return [{ title: getDefaultTitle(matches) }];\n};\n\nexport const handle: HandleFunction = {\n  uiTools: () => {\n    return <UiTools />;\n  },\n};\n\nexport async function loader({ request }: LoaderFunctionArgs) {\n  const url = new URL(request.url);\n  const tableParams = parseTableParams(url.search);\n\n  const data = await dataService.getList<Role>({\n    ...tableParams,\n    resource: EnumResource.role,\n    meta: {\n      include: {\n        creator: { select: { name: true, avatar: true } },\n      },\n    },\n  });\n\n  return { initialData: data };\n}\n\nexport default function RoleIndex() {\n  const { initialData } = useLoaderData<typeof loader>();\n\n  const friendly = useUserFriendlyName();\n  const { mutate: deleteMany } = useDeleteMany();\n  const { data: deletePermission } = useCan({ resource: EnumResource.role, action: EnumAction.delete });\n\n  const bulkDeleteAction = (table: UseTableReturnType<BaseRecord, HttpError>) => {\n    const rows = table.getSelectedRowModel().rows;\n    const label = `Delete Selected (${rows.length}) ${friendly('Row', rows.length > 1 ? 'plural' : 'singular')}`;\n\n    return {\n      className: 'text-destructive!',\n      label,\n      disabled: !deletePermission?.can,\n      onClick: () => {\n        deleteMany(\n          {\n            resource: EnumResource.role,\n            ids: rows.map((row) => row.original.id!),\n          },\n          {\n            onSuccess: () => {\n              table.resetRowSelection();\n            },\n          }\n        );\n      },\n    };\n  };\n\n  return (\n    <Table\n      enableSorting\n      enableFilters\n      enableHiding\n      initialState={{\n        sorting: [\n          {\n            id: 'createdAt',\n            desc: true,\n          },\n        ],\n      }}\n      refineCoreProps={{\n        queryOptions: { initialData },\n        meta: {\n          join: [\n            {\n              field: 'creator',\n              select: ['name', 'avatar'],\n            },\n          ],\n        },\n      }}\n    >\n      <Table.Column\n        accessorKey=\"id\"\n        id=\"id\"\n        header={({ table }) => <Table.CheckAll table={table} options={[bulkDeleteAction(table)]} />}\n        cell={({ row }) => (\n          <Checkbox\n            className=\"ml-2\"\n            checked={row.getIsSelected()}\n            onCheckedChange={(value) => row.toggleSelected(!!value)}\n            aria-label=\"Select row\"\n            key={`checkbox-${row.original.id}`}\n          />\n        )}\n      />\n\n      <Table.Column\n        header=\"Title\"\n        accessorKey=\"title\"\n        id=\"title\"\n        meta={{\n          filterOperator: 'contains',\n        }}\n        filter={(props: TableFilterProps) => <Table.Filter.Search {...props} title=\"Search Title\" />}\n        cell={({ row: { index, original }, table }) => {\n          const pageIndex = table.getState().pagination.pageIndex;\n          const pageSize = table.getState().pagination.pageSize;\n\n          return (\n            <ShowButton recordItemId={original.id} asChild>\n              <span className=\"text-muted-foreground inline-block min-w-8\">\n                {pageIndex * pageSize + index + 1}.&nbsp;\n              </span>\n              <span className=\"py-3 capitalize underline-offset-2 visited:text-red-600 hover:text-green-600 hover:underline\">\n                {original.title}\n              </span>\n            </ShowButton>\n          );\n        }}\n      />\n\n      <Table.Column\n        header=\"CreatedAt\"\n        accessorKey=\"createdAt\"\n        id=\"createdAt\"\n        enableSorting\n        enableHiding\n        filter={(props: TableFilterProps) => <Table.Filter.DateRangePicker {...props} align=\"end\" />}\n        cell={({ row: { original } }) => dayjs(original.createdAt).format('YYYY-MM-DD HH:mm:ss')}\n      />\n\n      <Table.Column\n        header=\"Creator\"\n        accessorKey=\"creator\"\n        id=\"creator\"\n        enableHiding\n        meta={{\n          filterOperator: 'contains',\n        }}\n        filter={(props: TableFilterProps) => <Table.Filter.Search {...props} title=\"Search Creator\" />}\n        cell={useCallback(\n          ({ row: { original } }: { row: { original: BaseRecord } }) => (\n            <div className=\"flex items-center gap-2\">\n              <Avatar className=\"size-6\">\n                <AvatarImage src={original.creator?.avatar || ''} alt={original.creator?.name || ''} />\n                <AvatarFallback>{original.creator?.name?.slice(0, 1).toUpperCase()}</AvatarFallback>\n              </Avatar>\n              <span>{original.creator?.name}</span>\n            </div>\n          ),\n          []\n        )}\n      />\n\n      <Table.Column\n        header=\"Actions\"\n        accessorKey=\"id\"\n        id=\"actions\"\n        cell={({ row: { original } }: { row: { original: BaseRecord } }) => (\n          <ShowButton recordItemId={original.id} size=\"icon\" variant=\"ghost\" />\n        )}\n      />\n    </Table>\n  );\n}\n\nfunction UiTools() {\n  return (\n    <div className=\"flex items-center gap-1 text-sm\">\n      <ExportButton variant=\"ghost\" size=\"icon\" />\n    </div>\n  );\n}\n\n// 错误边界处理\nexport function ErrorBoundary() {\n  return <PageError />;\n}\n"],"names":["meta","matches","title","getDefaultTitle","handle","uiTools","UiTools","RoleIndex","initialData","useLoaderData","friendly","useUserFriendlyName","mutate","deleteMany","useDeleteMany","data","deletePermission","useCan","resource","EnumResource","role","action","EnumAction","delete","bulkDeleteAction","table","rows","getSelectedRowModel","className","label","length","disabled","can","onClick","ids","map","row","original","id","onSuccess","resetRowSelection","jsxs","Table","enableSorting","enableFilters","enableHiding","initialState","sorting","desc","refineCoreProps","queryOptions","join","field","select","children","jsx","Column","accessorKey","header","CheckAll","options","cell","Checkbox","checked","getIsSelected","onCheckedChange","value","toggleSelected","filterOperator","filter","props","Filter","Search","index","pageIndex","getState","pagination","pageSize","ShowButton","recordItemId","asChild","DateRangePicker","align","dayjs","createdAt","format","useCallback","Avatar","AvatarImage","src","creator","avatar","alt","name","AvatarFallback","slice","toUpperCase","size","variant","ExportButton","ErrorBoundary","PageError"],"mappings":"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"}