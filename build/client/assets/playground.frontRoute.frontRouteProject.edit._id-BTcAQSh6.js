import{j as o}from"./jsx-runtime-C-_spy54.js";import{t as T}from"./form-jbmkrBBT.js";import{a as w}from"./index-Cif3Vfib.js";import{C as k,F as b}from"./field-DWIhesgQ.js";import{r as C}from"./index-aGVi9Z7h.js";import{t as x}from"./index-DJzNQfCY.js";import{z as u}from"./index-Cb7h-Ku-.js";import{P as A,u as J}from"./500-C3XOm4pH.js";import{C as M}from"./code-DVGvJ8US.js";import{C as N}from"./combobox-Q9vPxZ9d.js";import{F as R}from"./form-DXHbSOJg.js";import{D as $,a as q,b as B,c as D,d as V}from"./dialog-kz50Aa1u.js";import{I as O}from"./input-DOvfwVLE.js";import{E as h}from"./action-DSYjqVEc.js";import{O as P,p as L}from"./ty-BKnkfqXm.js";import{e as v}from"./axios-EFBqHVWI.js";import{g as U,d as W}from"./get-changed-values-vLde9APN.js";import{g as z}from"./form-BJoh7EuQ.js";import{g as G}from"./get-default-title-CrVGbO9H.js";import{s as H}from"./base-Dsx3AJoS.js";import{u as K}from"./components-BXAOArSq.js";const Q=u.object({title:u.string().min(2,{message:void 0}),description:u.string().optional().nullable(),global:u.any()}),Ee=({matches:e})=>[{title:G(e)}];function Fe(){const{initialData:e,myIssues:a}=K();return o.jsx(Z,{initialData:e,myIssues:a})}function Ce(){return o.jsx(A,{})}const Y=e=>({title:(e==null?void 0:e.title)||"",description:(e==null?void 0:e.description)||"",global:JSON.stringify((e==null?void 0:e.global)||{},null,2),issueId:""}),X=Q.extend({issueId:u.string().nonempty({message:"Issue is required"}),global:H}),Z=({className:e,redirect:a=h.list,initialData:r,action:c,myIssues:l=[]})=>{const{formAction:y,id:I=r==null?void 0:r.id,identifier:g}=w({action:c}),m=Y(r),p=k({resolver:T(X),defaultValues:m,warnWhenUnsavedChanges:!0,mode:"onChange",refineCoreProps:{resource:g,action:y,id:I,queryOptions:z(m),redirect:a}});async function E(i){const{issueId:s,param:n,...t}=i,d={[h.create]:P.ADD,[h.edit]:P.MODIFY},f=L(m,Object.keys(t));f.global&&(f.global=JSON.parse(f.global));const F={operateType:d[y],issueId:s,contentJsonObject:t,configType:"frontRoute",param:n,resource:g,id:r==null?void 0:r.id,data:t,dataPrevious:f},{data:S}=await v.post("/api/ty/deployServiceBuild",F);return S.data}const j=C.useCallback(async i=>{const s=U(i,m);s.global&&(s.global=JSON.parse(s.global));const n=W(s);try{const t=await E({...n,param:`frontRoute:${i.title}`});return x.success("配置发布申请推送成功",{description:t||"..."}),null}catch(t){throw x.error("配置发布申请执行错误",{description:(t==null?void 0:t.message)||"unknwon"}),t}},[]);return o.jsxs(R,{...p,beforeSubmit:j,className:e,recordItemId:r==null?void 0:r.id,children:[o.jsx(b,{...p,name:"title",label:"Title",children:o.jsx(O,{})}),o.jsx(b,{...p,name:"description",label:"Description",children:o.jsx(O,{className:"xl:w-1/2"})}),o.jsx(b,{...p,name:"global",label:"Global",children:o.jsx(M,{language:"json"})}),o.jsx(b,{...p,name:"issueId",label:"IssueId",children:o.jsx(N,{options:l.map(i=>({label:`${i.issueId} - ${i.title}`,value:String(i.issueId)}))})})]})},_=u.object({issueId:u.string().nonempty({message:"Issue is required"})}),ee=({records:e,formModalClose:a,className:r,tableResetRowSelection:c})=>{var j,i;const[l,y]=C.useState([]);J(async()=>{const{data:s}=await v.post("/api/ty/getMyIssues");y(s.data)});const{id:I=(j=e==null?void 0:e[0])==null?void 0:j.id,identifier:g}=w(),m=k({resolver:T(_),warnWhenUnsavedChanges:!1,mode:"onChange",refineCoreProps:{resource:g,action:h.edit,id:I}});async function p(s){const{issueId:n,param:t,id:d}=s,f={operateType:P.DELETE,issueId:n,contentJsonObject:{},configType:"frontRoute",param:t,resource:g,id:d},{data:F}=await v.post("/api/ty/deployServiceBuild",f);return F.data}const E=C.useCallback(async s=>{try{const n=[];e.forEach(d=>{n.push(p({...s,param:`frontRoute:${d.title}`,id:d.id}))});const t=await Promise.all(n);x.success("配置发布申请推送成功",{description:t[0]||"..."}),c==null||c()}catch(n){x.error("配置发布申请执行错误",{description:(n==null?void 0:n.message)||"unknwon"})}return null},[]);return o.jsx(R,{...m,beforeSubmit:E,className:r,recordItemId:(i=e==null?void 0:e[0])==null?void 0:i.id,formModalClose:a,children:o.jsx(b,{...m,name:"issueId",label:"IssueId",children:o.jsx(N,{popoverProps:{modal:!!a},options:l==null?void 0:l.map(s=>({label:`${s.issueId} - ${s.title}`,value:String(s.issueId)}))})})})};function Pe(e){const{visible:a,close:r,records:c,tableResetRowSelection:l}=e;return o.jsx($,{open:a,onOpenChange:r,children:o.jsxs(q,{children:[o.jsxs(B,{className:"text-destructive border-b pb-4",children:[o.jsx(D,{children:"删除项目"}),o.jsx(V,{children:"请选择关联需求，推送配置发布申请"})]}),o.jsx(ee,{className:"p-0",formModalClose:r,records:c,tableResetRowSelection:l})]})})}export{Ce as E,Pe as F,Z as a,Fe as b,Ee as m};
